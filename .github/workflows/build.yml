name: Build PRoot

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-glibc-static:
    name: Build with glibc (static) - aarch64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build with glibc (static, aarch64)
      run: |
        ./scripts/build-glibc-static-aarch64.sh
        
    - name: Upload glibc static binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-glibc-static-aarch64
        path: src/proot

  build-android-bionic:
    name: Build with Android Bionic (dynamic) - aarch64
    runs-on: ubuntu-24.04-arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Pull Termux container
      run: docker pull docker.io/termux/termux-docker:aarch64
        
    - name: Build with Termux container (dynamic, aarch64)
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          docker.io/termux/termux-docker:aarch64 \
          bash -c "cd /workspace && bash ./scripts/build-termux-android-dynamic-aarch64.sh"
        
    - name: Upload Android binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-android-bionic-aarch64
        path: src/proot

  build-android-static:
    name: Build with Android Bionic (static) - aarch64
    runs-on: ubuntu-24.04-arm64
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Pull Termux container
      run: docker pull docker.io/termux/termux-docker:aarch64
        
    - name: Build with Termux container (static, aarch64)
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          docker.io/termux/termux-docker:aarch64 \
          bash -c "cd /workspace && bash ./scripts/build-termux-android-static-aarch64.sh"
        
    - name: Upload Android static binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-android-static-aarch64
        path: src/proot
