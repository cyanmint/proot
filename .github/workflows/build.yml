name: Build PRoot

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-glibc-static:
    name: Build with glibc (static) - aarch64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build with glibc (static, aarch64)
      run: |
        ./scripts/build-glibc-static-aarch64.sh
        
    - name: Upload glibc static binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-glibc-static-aarch64
        path: src/proot

  build-android-bionic:
    name: Build with Android Bionic (dynamic) - aarch64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b
        
    - name: Build with Android NDK (aarch64)
      run: ./scripts/build-android-aarch64.sh
        
    - name: Upload Android binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-android-bionic-aarch64
        path: src/proot

  build-android-static:
    name: Build with Android Bionic (static) - aarch64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b
        
    - name: Build with Android NDK (static, aarch64)
      run: ./scripts/build-android-static-aarch64.sh
        
    - name: Upload Android static binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-android-static-aarch64
        path: src/proot

  build-termux-aarch64:
    name: Build and Test in Termux (aarch64)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Build proot in Termux container
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          termux/termux-docker:aarch64 \
          bash -c '
            set -e
            echo "=== Checking environment ==="
            uname -a
            which clang || echo "clang not found"
            which make || echo "make not found"
            
            echo "=== Installing build dependencies ==="
            # Try to update and install, but continue even if it fails
            pkg update -y 2>&1 || true
            pkg install -y clang make libtalloc 2>&1 || true
            
            # Check if tools are available
            if ! which clang; then
              echo "ERROR: clang not available and could not be installed"
              echo "This is likely due to network issues with Termux mirrors"
              exit 1
            fi
            
            if ! which make; then
              echo "ERROR: make not available and could not be installed"
              exit 1
            fi
            
            echo "=== Building proot ==="
            cd src
            make clean 2>&1 || true
            make -j$(nproc) proot
            
            echo "=== Testing proot ==="
            ./proot --version
            echo "Build successful!"
          '
        
    - name: Upload Termux binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-termux-aarch64
        path: src/proot
