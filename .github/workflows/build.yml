name: Build PRoot

on:
  push:
    branches: [ main, master, copilot/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-musl-static:
    name: Build with musl (static) - aarch64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
          qemu-user-static python3-dev wget
        
    - name: Download and setup musl for aarch64
      run: |
        cd /tmp
        # Download musl source
        wget https://musl.libc.org/releases/musl-1.2.5.tar.gz
        tar -xzf musl-1.2.5.tar.gz
        cd musl-1.2.5
        # Build musl for aarch64
        ./configure --prefix=/usr/local/musl-aarch64 \
          --target=aarch64-linux-musl \
          CC=aarch64-linux-gnu-gcc
        make -j$(nproc)
        sudo make install
        # Create musl-gcc wrapper
        sudo tee /usr/local/bin/aarch64-linux-musl-gcc > /dev/null << 'WRAPPER'
        #!/bin/sh
        exec /usr/local/musl-aarch64/bin/musl-gcc "$@"
        WRAPPER
        sudo chmod +x /usr/local/bin/aarch64-linux-musl-gcc
        
    - name: Build talloc for musl aarch64
      run: |
        cd /tmp
        wget https://www.samba.org/ftp/talloc/talloc-2.4.2.tar.gz
        tar -xzf talloc-2.4.2.tar.gz
        cd talloc-2.4.2
        # Build talloc for aarch64 with musl
        CC=aarch64-linux-gnu-gcc \
          AR=aarch64-linux-gnu-ar \
          ./configure --prefix=/usr/local/musl-aarch64 \
          --disable-python --disable-rpath --cross-compile --cross-execute="qemu-aarch64-static -L /usr/aarch64-linux-gnu"
        make -j$(nproc)
        sudo make install
        
    - name: Create ashmem header
      run: |
        sudo mkdir -p /usr/include/linux
        sudo tee /usr/include/linux/ashmem.h > /dev/null << 'EOF'
        #ifndef _LINUX_ASHMEM_H
        #define _LINUX_ASHMEM_H
        #include <linux/ioctl.h>
        #include <linux/types.h>
        #define ASHMEM_NAME_LEN 256
        #define ASHMEM_NAME_DEF "dev/ashmem"
        #define ASHMEM_NOT_PURGED 0
        #define ASHMEM_WAS_PURGED 1
        #define ASHMEM_IS_UNPINNED 0
        #define ASHMEM_IS_PINNED 1
        struct ashmem_pin {
          __u32 offset;
          __u32 len;
        };
        #define __ASHMEMIOC 0x77
        #define ASHMEM_SET_NAME _IOW(__ASHMEMIOC, 1, char[ASHMEM_NAME_LEN])
        #define ASHMEM_GET_NAME _IOR(__ASHMEMIOC, 2, char[ASHMEM_NAME_LEN])
        #define ASHMEM_SET_SIZE _IOW(__ASHMEMIOC, 3, size_t)
        #define ASHMEM_GET_SIZE _IO(__ASHMEMIOC, 4)
        #define ASHMEM_SET_PROT_MASK _IOW(__ASHMEMIOC, 5, unsigned long)
        #define ASHMEM_GET_PROT_MASK _IO(__ASHMEMIOC, 6)
        #define ASHMEM_PIN _IOW(__ASHMEMIOC, 7, struct ashmem_pin)
        #define ASHMEM_UNPIN _IOW(__ASHMEMIOC, 8, struct ashmem_pin)
        #define ASHMEM_GET_PIN_STATUS _IO(__ASHMEMIOC, 9)
        #define ASHMEM_PURGE_ALL_CACHES _IO(__ASHMEMIOC, 10)
        #endif
        EOF
        
    - name: Build with musl (static linking) - aarch64
      run: |
        cd src
        make clean
        # Build for aarch64 with musl
        CC=aarch64-linux-gnu-gcc \
          CFLAGS="-I/usr/local/musl-aarch64/include -static" \
          LDFLAGS="-L/usr/local/musl-aarch64/lib -static -ltalloc" \
          make
        file proot
        ls -lh proot
        # Verify architecture
        file proot | grep aarch64 || { echo "ERROR: Not aarch64 binary"; exit 1; }
        
    - name: Upload musl static binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-musl-static-aarch64
        path: src/proot

  build-android-bionic:
    name: Build with Android Bionic (dynamic) - aarch64
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26b
        
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev wget
        
    - name: Create ashmem header
      run: |
        sudo mkdir -p /usr/include/linux
        sudo tee /usr/include/linux/ashmem.h > /dev/null << 'EOF'
        #ifndef _LINUX_ASHMEM_H
        #define _LINUX_ASHMEM_H
        #include <linux/ioctl.h>
        #include <linux/types.h>
        #define ASHMEM_NAME_LEN 256
        #define ASHMEM_NAME_DEF "dev/ashmem"
        #define ASHMEM_NOT_PURGED 0
        #define ASHMEM_WAS_PURGED 1
        #define ASHMEM_IS_UNPINNED 0
        #define ASHMEM_IS_PINNED 1
        struct ashmem_pin {
          __u32 offset;
          __u32 len;
        };
        #define __ASHMEMIOC 0x77
        #define ASHMEM_SET_NAME _IOW(__ASHMEMIOC, 1, char[ASHMEM_NAME_LEN])
        #define ASHMEM_GET_NAME _IOR(__ASHMEMIOC, 2, char[ASHMEM_NAME_LEN])
        #define ASHMEM_SET_SIZE _IOW(__ASHMEMIOC, 3, size_t)
        #define ASHMEM_GET_SIZE _IO(__ASHMEMIOC, 4)
        #define ASHMEM_SET_PROT_MASK _IOW(__ASHMEMIOC, 5, unsigned long)
        #define ASHMEM_GET_PROT_MASK _IO(__ASHMEMIOC, 6)
        #define ASHMEM_PIN _IOW(__ASHMEMIOC, 7, struct ashmem_pin)
        #define ASHMEM_UNPIN _IOW(__ASHMEMIOC, 8, struct ashmem_pin)
        #define ASHMEM_GET_PIN_STATUS _IO(__ASHMEMIOC, 9)
        #define ASHMEM_PURGE_ALL_CACHES _IO(__ASHMEMIOC, 10)
        #endif
        EOF
        
    - name: Build talloc for Android aarch64
      run: |
        cd /tmp
        wget https://www.samba.org/ftp/talloc/talloc-2.4.2.tar.gz
        tar -xzf talloc-2.4.2.tar.gz
        cd talloc-2.4.2
        # Setup Android NDK environment
        export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
        export TARGET=aarch64-linux-android
        export API=21
        export CC=$TOOLCHAIN/bin/$TARGET$API-clang
        export AR=$TOOLCHAIN/bin/llvm-ar
        export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
        # Build talloc for Android
        ./configure --prefix=/tmp/android-talloc \
          --disable-python --disable-rpath \
          --cross-compile --cross-execute=""
        make -j$(nproc)
        make install
        
    - name: Build with Android NDK (aarch64)
      run: |
        cd src
        make clean
        export TOOLCHAIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64
        export TARGET=aarch64-linux-android
        export API=21
        export CC=$TOOLCHAIN/bin/$TARGET$API-clang
        # Build with Android NDK
        CC=$CC \
          CFLAGS="-I/tmp/android-talloc/include" \
          LDFLAGS="-L/tmp/android-talloc/lib" \
          make
        file proot
        ls -lh proot
        # Verify architecture
        file proot | grep aarch64 || { echo "ERROR: Not aarch64 binary"; exit 1; }
        
    - name: Upload Android binary
      uses: actions/upload-artifact@v6
      with:
        name: proot-android-bionic-aarch64
        path: src/proot
