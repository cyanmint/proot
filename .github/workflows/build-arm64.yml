name: Build ARM64

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest-arm64
    permissions:
      contents: read
    container:
      image: docker.io/termux/docker-termux:aarch64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # Install build dependencies
          # Note: Termux packages include dev files by default, while Debian/Ubuntu require -dev suffix
          if command -v pkg > /dev/null 2>&1; then
            # Termux package manager
            pkg update -y
            pkg install -y libtalloc clang make
          elif command -v apt-get > /dev/null 2>&1; then
            # Debian/Ubuntu package manager
            apt-get update -qq
            apt-get install -y libtalloc-dev gcc make
          else
            echo "No supported package manager found"
            exit 1
          fi

      - name: Build dynamic version
        run: |
          cd src
          make clean || true  # First build may have nothing to clean
          make
          cp proot proot-dynamic

      - name: Build static version
        run: |
          cd src
          make clean
          # Override LDFLAGS to include -static flag
          # Note: We explicitly include all original LDFLAGS from the Makefile plus -static
          # Cannot use LDFLAGS="$(LDFLAGS) -static" as it causes recursive variable reference
          make LDFLAGS="-ltalloc -Wl,-z,noexecstack -static"
          cp proot proot-static

      - name: Verify builds
        run: |
          file src/proot-dynamic
          file src/proot-static
          ls -lh src/proot-dynamic src/proot-static

      - name: Upload dynamic build artifact
        uses: actions/upload-artifact@v4
        with:
          name: proot-aarch64-dynamic
          path: src/proot-dynamic

      - name: Upload static build artifact
        uses: actions/upload-artifact@v4
        with:
          name: proot-aarch64-static
          path: src/proot-static
